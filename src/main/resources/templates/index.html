<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск сообщений по email</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }
        .message-row {
            transition: background-color 0.3s;
        }
        .message-row:hover {
            background-color: #f8f9fa;
        }
        .selected {
            background-color: #e3f2fd !important;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1 class="mb-4">Поиск сообщений по email</h1>

    <form th:action="@{/search}" method="post" th:object="${searchRequest}" class="mb-4">
        <div class="row g-3 align-items-center">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="email" th:field="*{email}" class="form-control"
                           placeholder="Введите email для поиска" required>
                    <button type="submit" class="btn btn-primary">Поиск</button>
                </div>
            </div>
            <div class="col-md-6">
                <button type="button" class="btn btn-warning" id="resendBtn" disabled>
                    Отправить повторно (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>
    </form>

    <div th:if="${messages != null}" class="mt-4">
        <h3>Результаты поиска</h3>

        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAll">
                    </th>
                    <th>ID</th>
                    <th>Топик Kafka</th>
                    <th>Сообщение (XML)</th>
                    <th>Дата создания</th>
                    <th>Статус</th>
                    <th>Дата окончания</th>
                    <th>Сервер</th>
                    <th>Попытки</th>
                    <th>Тип</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="message : ${messages}" class="message-row"
                    th:data-id="${message.id}">
                    <td>
                        <input type="checkbox" class="message-checkbox">
                    </td>
                    <td th:text="${message.id}"></td>
                    <td th:text="${message.kafkaTopic}"></td>
                    <td>
                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                             th:text="${message.message}"></div>
                    </td>
                    <td th:text="${message.dateCreate}"></td>
                    <td th:text="${message.status}"></td>
                    <td th:text="${message.dateEnd}"></td>
                    <td th:text="${message.server}"></td>
                    <td th:text="${message.numAttempt}"></td>
                    <td th:text="${message.typeMes}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div th:unless="${messages != null}" class="alert alert-info">
        Введите email для поиска сообщений
    </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="overlay"></div>
<div id="loadingSpinner" class="loading">
    <div class="loading-spinner"></div>
    <div class="mt-2">Обновление сообщений...</div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        let selectedMessages = [];

        // Обработка выбора/снятия выбора с чекбоксов
        $('body').on('change', '.message-checkbox', function() {
            const row = $(this).closest('tr');
            const messageId = row.data('id');

            if ($(this).is(':checked')) {
                row.addClass('selected');
                if (!selectedMessages.includes(messageId)) {
                    selectedMessages.push(messageId);
                }
            } else {
                row.removeClass('selected');
                selectedMessages = selectedMessages.filter(id => id !== messageId);
            }

            updateSelectedCount();
            updateResendButton();
        });

        // Выбрать все
        $('#selectAll').change(function() {
            const isChecked = $(this).is(':checked');
            $('.message-checkbox').prop('checked', isChecked).trigger('change');
        });

        // Кнопка "Отправить повторно"
        $('#resendBtn').click(function() {
            if (selectedMessages.length === 0) return;

            // Показываем анимацию загрузки
            $('#loadingOverlay').show();
            $('#loadingSpinner').show();

            // Отправляем запрос на сервер
            $.ajax({
                url: '/api/resend',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ messageIds: selectedMessages }),
                success: function(response) {
                    if (response.success) {
                        alert('Успешно обновлено сообщений: ' + response.updatedCount);

                        // Обновляем таблицу с обновленными данными
                        if (response.messages) {
                            response.messages.forEach(msg => {
                                const row = $(`tr[data-id="${msg.id}"]`);
                                if (row.length) {
                                    row.find('td:nth-child(5)').text(msg.dateCreate || '');
                                    row.find('td:nth-child(6)').text(msg.status || '');
                                    row.find('td:nth-child(7)').text(msg.dateEnd || '');
                                    row.find('td:nth-child(8)').text(msg.server || '');
                                }
                            });
                        }
                    } else {
                        alert('Ошибка: ' + response.error);
                    }
                },
                error: function() {
                    alert('Ошибка при отправке запроса');
                },
                complete: function() {
                    // Скрываем анимацию загрузки
                    $('#loadingOverlay').hide();
                    $('#loadingSpinner').hide();

                    // Сбрасываем выбор
                    selectedMessages = [];
                    $('.message-checkbox').prop('checked', false);
                    $('.message-row').removeClass('selected');
                    $('#selectAll').prop('checked', false);
                    updateSelectedCount();
                    updateResendButton();
                }
            });
        });

        function updateSelectedCount() {
            $('#selectedCount').text(selectedMessages.length);
        }

        function updateResendButton() {
            $('#resendBtn').prop('disabled', selectedMessages.length === 0);
        }
    });
</script>
</body>
</html>