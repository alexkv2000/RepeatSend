<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск сообщений</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-size: 14px;
        }

        .container-fluid {
            max-width: 95%;
        }

        /* Стили для анимации загрузки */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }

        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            text-align: center;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Основной контейнер с двумя колонками */
        .main-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            height: 75vh;
        }

        /* Левая колонка с таблицей */
        .table-container {
            flex: 0 0 60%;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-height: 75vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Правая колонка с деталями сообщения */
        .message-details {
            flex: 0 0 38%;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Заголовок области деталей */
        .details-header {
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Контейнер для XML/HTML */
        .html-container {
            flex: 1;
            min-height: 0; /* Важно для правильной работы flex в старых браузерах */
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            transition: all 0.3s ease; /* Плавная анимация */
        }
        /* Класс для увеличенной высоты */
        .html-container.expanded {
            flex: 1 0 auto;
        }
        /* Строки таблицы */
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-row:hover {
            background-color: #f0f8ff !important;
        }

        .clickable-row.selected {
            background-color: #e3f2fd !important;
            border-left: 3px solid #007bff;
        }

        /* Статус сообщения */
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-null {
            background-color: #e2e3e5;
            color: #383d41;
        }

        /* Иконки */
        .icon-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .icon-btn:hover {
            color: #007bff;
            background: #f8f9fa;
        }

        /* Кнопки управления */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }

        /* Счетчик выделенных */
        .selected-counter {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Таблица */
        .message-table {
            width: 100%;
            margin-bottom: 10px;
            flex: 1;
            overflow-y: auto;
        }

        .message-table tbody {
            display: block;
            max-height: calc(19 * 41px); /* 23 строки × высота строки */
            overflow-y: auto;
        }

        .message-table thead,
        .message-table tbody tr {
            display: table;
            width: 100%;
            margin-bottom: 10px;
            flex: 1;
            table-layout: fixed;
        }

        .message-table tbody tr {
            height: 40px;
        }

        /* Фиксируем высоту заголовка */
        .message-table thead {
            height: 41px;
        }

        /* Стиль для UUID (усеченный текст) */
        .uuid-cell {
            max-width: 360px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Стиль для типа сообщения */
        .type-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .type-email {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .type-sms {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .type-push {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .type-default {
            background-color: #f5f5f5;
            color: #616161;
        }

        /* Стили для адресов */
        .email-address {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            word-break: break-all;
        }

        .email-list {
            max-height: 80px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 5px;
            margin-top: 3px;
        }

        .date-autocomplete {
            position: relative;
        }

        .date-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .date-suggestion-item {
            padding: 5px 10px;
            cursor: pointer;
        }

        .date-suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .details-title {
            transition: color 0.2s;
        }

        .details-title:hover {
            color: #007bff;
        }

        #detailsToggleIcon {
            transition: transform 0.3s;
            font-size: 12px;
        }
        /* Для блока с информацией о сообщении */
        #messageInfo {
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: 15px;
        }

        /* Добавим класс для скрытого состояния */
        #messageInfo.hidden {
            margin-bottom: 0;
            padding: 0;
            border: none;
            height: 0;
            opacity: 0;
        }

        /* Стили для формы редактирования */
        .form-control-sm {
            font-size: 12px;
        }

        .edit-field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }

        .edit-btn-sm {
            padding: 0;
            font-size: 10px;
            height: 16px;
            width: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-3">
    <!-- Форма поиска -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-4">
                <i class="fas fa-search me-2"></i>Поиск сообщений
            </h5>
            <form th:action="@{/search}" method="post" th:object="${searchRequest}" id="searchForm">
                <div class="row g-3 align-items-center">
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-envelope"></i>
                            </span>
                            <input type="email" th:field="*{email}" class="form-control"
                                   placeholder="Email для поиска (user@example.com)"
                                   id="emailInput">
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="date-autocomplete">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-calendar"></i>
                                </span>
                                <input type="date" th:field="*{dateCreate}" class="form-control"
                                       id="dateInput"
                                       th:value="${searchRequest.dateCreate != null} ?
                                               ${#temporals.format(searchRequest.dateCreate, 'yyyy-MM-dd')} : ''">
                                <button type="button" class="btn btn-outline-secondary" onclick="clearDate()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <!-- Список уникальных дат для автозаполнения -->
                            <div class="date-suggestions" id="dateSuggestions">
                                <div th:each="date : ${uniqueDates}"
                                     class="date-suggestion-item"
                                     th:data-date="${#temporals.format(date, 'yyyy-MM-dd')}"
                                     th:text="${#temporals.format(date, 'dd.MM.yyyy')}"
                                     onclick="selectDate(this)"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i> Найти
                        </button>
                    </div>
                </div>
                <div class="form-text mt-2">
                    Заполните хотя бы одно поле
                </div>

                <!-- Сообщение об ошибке -->
                <div th:if="${error != null}" class="alert alert-danger mt-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span th:text="${error}"></span>
                </div>

                <!-- Информация о текущем поиске -->
                <div th:if="${searchResultCount != null}" class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <span th:text="'Найдено сообщений: ' + ${searchResultCount}"></span>
                    <span th:if="${searchRequest.email != null and !searchRequest.email.isEmpty()}"
                          th:text="' | Email: ' + ${searchRequest.email}" class="ms-2"></span>
                    <span th:if="${searchRequest.dateCreate != null}"
                          th:text="' | Дата: ' + ${#temporals.format(searchRequest.dateCreate, 'dd.MM.yyyy')}"
                          class="ms-2"></span>
                </div>
            </form>
        </div>
    </div>

    <!-- Результаты поиска -->
    <div th:if="${messages != null and !messages.empty}">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>
                <i class="fas fa-list me-2"></i>
                Найдено сообщений: <span th:text="${messages.size()}" class="badge bg-primary"></span>
            </h5>
            <div>
                <div class="form-check form-check-inline">
                    <input type="checkbox" class="form-check-input" id="selectAll">
                    <label class="form-check-label" for="selectAll">Выбрать все</label>
                </div>
                <button type="button" class="btn btn-warning" id="resendBtn" disabled>
                    <i class="fas fa-redo-alt me-1"></i>
                    Отправить повторно
                    <span id="selectedCount" class="selected-counter">0</span>
                </button>
            </div>
        </div>

        <!-- Основной контейнер с двумя колонками -->
        <div class="main-container">

            <!-- Левая колонка: таблица -->
            <div class="table-container">
                <table class="message-table">
                    <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAllTable">
                        </th>
                        <th style="width: 60px;">ID</th>
                        <th style="width: 260px;">UUID</th>
                        <th style="width: 120px;">Тип</th>
                        <th>Топик Kafka</th>
                        <th>Статус</th>
                        <th>Дата создания</th>
                        <th>Дата окончания</th>
                        <th style="width: 80px;">Попытки</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="message : ${messages}"
                        class="clickable-row"
                        th:data-id="${message.id}"
                        onclick="selectRow(this)">
                        <td style="width: 40px;">
                            <input type="checkbox" class="message-checkbox" onclick="toggleSelect(this, event)">
                        </td>
                        <td style="width: 60px;" th:text="${message.id}"></td>
                        <td style="width: 260px;" class="uuid-cell" title="${message.UUID}">
                            <small th:text="${message.UUID} ? ${#strings.abbreviate(message.UUID, 37)} : 'Нет'"></small>
                        </td>
                        <td style="width: 120px;">
                            <!-- Отображение типа сообщения с цветовой индикацией -->
                            <span th:if="${message.typeMes == null or message.typeMes == ''}"
                                  class="type-badge type-default">-</span>
                            <span th:if="${message.typeMes != null and message.typeMes == 'EMAIL'}"
                                  class="type-badge type-email" th:text="${message.typeMes}"></span>
                            <span th:if="${message.typeMes != null and message.typeMes == 'SMS'}"
                                  class="type-badge type-sms" th:text="${message.typeMes}"></span>
                            <span th:if="${message.typeMes != null and message.typeMes == 'PUSH'}"
                                  class="type-badge type-push" th:text="${message.typeMes}"></span>
                            <span th:if="${message.typeMes != null and message.typeMes != 'EMAIL' and message.typeMes != 'SMS' and message.typeMes != 'PUSH'}"
                                  class="type-badge type-default" th:text="${message.typeMes}"></span>
                        </td>
                        <td style="width: 120px;">
                            <small th:text="${message.kafkaTopic}"></small>
                        </td>
                        <td style="width: 120px;">
                            <!-- Безопасное отображение статуса -->
                            <span th:if="${message.status == null}" class="status-badge status-null">Нет</span>
                            <span th:if="${message.status != null and message.status == 'SUCCESS'}"
                                  class="status-badge status-success" th:text="${message.status}"></span>
                            <span th:if="${message.status != null and message.status == 'ERROR'}"
                                  class="status-badge status-error" th:text="${message.status}"></span>
                            <span th:if="${message.status != null and message.status != 'SUCCESS' and message.status != 'ERROR'}"
                                  class="status-badge status-pending" th:text="${message.status}"></span>
                        </td>
                        <td style="width: 120px;">
                            <small th:text="${#temporals.format(message.dateCreate, 'dd.MM.yyyy HH:mm')}"></small>
                        </td>
                        <td style="width: 120px;">
                            <small th:if="${message.dateEnd != null}"
                                   th:text="${#temporals.format(message.dateEnd, 'dd.MM.yyyy HH:mm')}"></small>
                            <small th:if="${message.dateEnd == null}" class="text-muted">-</small>
                        </td>
                        <td style="width: 40px;">
                                    <span th:text="${message.numAttempt}"
                                          th:class="${message.numAttempt != null and message.numAttempt > 3} ? 'badge bg-danger' : 'badge bg-secondary'">
                                    </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Правая колонка: детали сообщения -->
            <div class="message-details">
                <div class="details-header">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="fas fa-file-code me-2"></i>
                            <span class="details-title" style="cursor: pointer;" onclick="toggleMessageInfo()">
                                Детали сообщения
                                <i id="detailsToggleIcon" class="fas fa-chevron-down ms-1"></i>
                            </span>
                        </h6>
                        <div class="d-flex align-items-center">
                            <span id="detailMessageId" class="badge bg-secondary me-2">ID: -</span>
                            <button class="icon-btn" onclick="copyContent()" title="Копировать содержимое">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="icon-btn" onclick="copyDetails()" title="Копировать детали">
                                <i class="fas fa-clipboard-list"></i>
                            </button>
                            <!-- Кнопка редактирования -->
                            <button class="icon-btn" onclick="toggleEditMode()" title="Редактировать адреса">
                                <i id="editIcon" class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-muted small">
                        Нажмите на заголовок для показа/скрытия информации
                    </div>
                </div>

                <!-- Блок с основной информацией -->
                <div id="messageInfo" class="mb-3 p-3 border rounded" style="display: none;">
                    <!-- Режим просмотра -->
                    <div id="viewMode">
                        <!-- Блок 1: Основная информация -->
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <small class="text-muted d-block">UUID:</small>
                                <div id="infoUUID" class="email-address small"></div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted d-block">Тип:</small>
                                <div id="infoType"></div>
                            </div>
                        </div>

                        <!-- Блок 2: Даты -->
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <small class="text-muted d-block">Дата создания:</small>
                                <div id="infoDateCreate" class="small"></div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted d-block">Дата окончания:</small>
                                <div id="infoDateEnd" class="small"></div>
                            </div>
                        </div>

                        <!-- Блок 3: Статус и попытки -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <small class="text-muted d-block">Статус:</small>
                                <div id="infoStatus"></div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted d-block">Попыток:</small>
                                <div id="infoAttempts"></div>
                            </div>
                        </div>

                        <!-- Блок 4: Адресаты -->
                        <div class="row mb-2">
                            <div class="col-md-12">
                                <small class="text-muted d-block">Тема (Caption):</small>
                                <div id="infoCaption" class="fw-semibold small"></div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="edit-field-header mb-1">
                                    <small class="text-muted">To (Кому):</small>
                                    <button class="btn btn-sm btn-link p-0 edit-btn-sm" onclick="editField('To')" title="Редактировать">
                                        <i class="fas fa-edit fa-xs"></i>
                                    </button>
                                </div>
                                <div id="infoTo" class="email-list small"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="edit-field-header mb-1">
                                    <small class="text-muted">ToCC (Копия):</small>
                                    <button class="btn btn-sm btn-link p-0 edit-btn-sm" onclick="editField('ToCC')" title="Редактировать">
                                        <i class="fas fa-edit fa-xs"></i>
                                    </button>
                                </div>
                                <div id="infoToCC" class="email-list small"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="edit-field-header mb-1">
                                    <small class="text-muted">BCC (Скрытая копия):</small>
                                    <button class="btn btn-sm btn-link p-0 edit-btn-sm" onclick="editField('BCC')" title="Редактировать">
                                        <i class="fas fa-edit fa-xs"></i>
                                    </button>
                                </div>
                                <div id="infoBCC" class="email-list small"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Режим редактирования -->
                    <div id="editMode" style="display: none;">
                        <div class="alert alert-info mb-2 py-2">
                            <i class="fas fa-edit me-1"></i> Режим редактирования адресов
                        </div>

                        <form id="editForm" onsubmit="saveChanges(event)">
                            <div class="mb-3">
                                <label class="form-label small mb-1">To (Кому):</label>
                                <textarea id="editTo" class="form-control form-control-sm"
                                          rows="2" placeholder="Введите email через запятую"></textarea>
                                <div class="form-text">Разделяйте email запятыми</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small mb-1">ToCC (Копия):</label>
                                <textarea id="editToCC" class="form-control form-control-sm"
                                          rows="2" placeholder="Введите email через запятую"></textarea>
                                <div class="form-text">Разделяйте email запятыми</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small mb-1">BCC (Скрытая копия):</label>
                                <textarea id="editBCC" class="form-control form-control-sm"
                                          rows="2" placeholder="Введите email через запятую"></textarea>
                                <div class="form-text">Разделяйте email запятыми</div>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit()">
                                    Отмена
                                </button>
                                <button type="submit" class="btn btn-sm btn-primary">
                                    Сохранить
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Контейнер для содержимого -->
                <div id="htmlContainer" class="html-container">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                        <p>Выберите сообщение из таблицы для просмотра</p>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleView()">
                        <i class="fas fa-exchange-alt me-1"></i> Переключить вид
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="searchInContent()">
                        <i class="fas fa-search me-1"></i> Поиск в тексте
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="highlightEmail()">
                        <i class="fas fa-highlighter me-1"></i> Подсветить email
                    </button>
                    <!-- Новая кнопка для обновления размеров -->
                    <button class="btn btn-sm btn-outline-warning" onclick="resizeContentIframe()" title="Обновить размеры">
                        <i class="fas fa-expand-alt me-1"></i> Обновить размер
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Сообщение если нет результатов -->
    <div th:if="${messages != null and messages.empty}" class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Сообщений не найдено. Измените параметры поиска.
    </div>

    <!-- Сообщение при первом входе -->
    <div th:unless="${messages != null}" class="alert alert-secondary">
        <i class="fas fa-info-circle me-2"></i>
        Введите email и/или выберите дату для поиска сообщений
    </div>
</div>

<!-- Overlay и спиннер для загрузки -->
<div id="loadingOverlay" class="loading-overlay"></div>
<div id="loadingSpinner" class="loading-spinner" style="display: none;">
    <div class="spinner"></div>
    <div class="mt-2">Обработка...</div>
</div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script>
    // Глобальные переменные
    let selectedMessages = [];
    let currentSelectedId = null;
    let currentViewMode = 'preview'; // 'preview' или 'source'
    let currentMessageData = {}; // Храним все данные текущего сообщения
    let isEditMode = false;
    let originalFields = {};

    $(document).ready(function () {
        console.log('Страница загружена');

        initDateField();
        restoreMessageInfoState();

        // Обработчик для "Выбрать все"
        $('#selectAll, #selectAllTable').change(function () {
            const isChecked = $(this).is(':checked');
            $('.message-checkbox').prop('checked', isChecked).each(function () {
                const messageId = $(this).closest('tr').data('id');
                updateSelection(messageId, isChecked);
            });
            updateUI();
        });

        // Отслеживание ввода email для подсветки
        $('#emailInput').on('input', function() {
            const email = $(this).val().trim();

            // Если email введен и есть выбранное сообщение, можно предложить подсветить
            if (email && currentSelectedId && window.currentMessageContent) {
                // Можно добавить индикатор, что email можно подсветить
                const highlightBtn = $('button[onclick="highlightEmail()"]');
                highlightBtn.addClass('btn-info').removeClass('btn-outline-info');
                highlightBtn.html('<i class="fas fa-highlighter me-1"></i> Подсветить: ' + email.substring(0, 15) + '...');
            }
        });

        // Сброс кнопки при очистке поля
        $('#emailInput').on('blur', function() {
            if (!$(this).val().trim()) {
                const highlightBtn = $('button[onclick="highlightEmail()"]');
                highlightBtn.removeClass('btn-info').addClass('btn-outline-info');
                highlightBtn.html('<i class="fas fa-highlighter me-1"></i> Подсветить email');
            }
        });

        // Обработчик для кнопки "Отправить повторно"
        $('#resendBtn').click(resendSelectedMessages);
    });

    // Инициализация поля даты
    function initDateField() {
        const dateInput = $('#dateInput');
        const suggestions = $('#dateSuggestions');

        // Показываем предложения при фокусе
        dateInput.on('focus', function () {
            if (suggestions.children().length > 0) {
                suggestions.show();
            }
        });

        // Скрываем предложения при клике вне поля
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.date-autocomplete').length) {
                suggestions.hide();
            }
        });

        // Фильтрация предложений при вводе
        dateInput.on('input', function () {
            const value = $(this).val().toLowerCase();
            if (value) {
                suggestions.children().each(function () {
                    const dateText = $(this).text().toLowerCase();
                    const dateValue = $(this).data('date').toLowerCase();
                    const isVisible = dateText.includes(value) || dateValue.includes(value);
                    $(this).toggle(isVisible);
                });
                suggestions.show();
            } else {
                suggestions.children().show();
                suggestions.show();
            }
        });
    }

    // Выбор строки таблицы
    function selectRow(rowElement) {
        const messageId = $(rowElement).data('id');
        if (!messageId) return;

        // Снимаем выделение со всех строк и добавляем к текущей
        $('.clickable-row').removeClass('selected');
        $(rowElement).addClass('selected');

        currentSelectedId = messageId;

        // Выходим из режима редактирования если он был активен
        if (isEditMode) {
            exitEditMode();
        }

        loadMessageDetails(messageId);
    }

    // Переключение выбора чекбокса
    function toggleSelect(checkbox, event) {
        if (event) event.stopPropagation();

        const row = $(checkbox).closest('tr');
        const messageId = row.data('id');
        const isChecked = $(checkbox).is(':checked');

        updateSelection(messageId, isChecked);
        updateUI();
    }

    // Обновление выбора
    function updateSelection(messageId, isSelected) {
        if (isSelected) {
            if (!selectedMessages.includes(messageId)) {
                selectedMessages.push(messageId);
            }
        } else {
            selectedMessages = selectedMessages.filter(id => id !== messageId);
        }
    }

    // Загрузка деталей сообщения
    function loadMessageDetails(messageId) {
        console.log('Загрузка сообщения ID:', messageId);

        // Обновляем заголовок
        $('#detailMessageId').text('ID: ' + messageId);
        $('#detailMessageId').removeClass('bg-secondary bg-primary').addClass('bg-primary');

        // Показываем загрузку
        $('#messageInfo').hide();
        $('#htmlContainer').html(`
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2 text-muted">Загрузка содержимого...</p>
            </div>
        `);

        // Загружаем с сервера
        $.ajax({
            url: '/api/message/' + messageId + '/full',
            type: 'GET',
            success: function (response) {
                if (response.success && response.message) {
                    // Сохраняем все данные сообщения
                    currentMessageData = {
                        message: response.message,
                        fields: response.fields || {}
                    };

                    updateMessageInfo(response.message, response.fields);

                    // Восстанавливаем состояние видимости
                    setTimeout(() => {
                        restoreMessageInfoState();

                        // Обновляем высоту после загрузки данных
                        setTimeout(() => {
                            if (response.bodyContent) {
                                displayMessageContent(response.bodyContent);
                                resizeContentIframe();
                            }
                        }, 100);
                    }, 0);
                } else {
                    showError('Ошибка загрузки: ' + (response.error || 'Неизвестная ошибка'));
                }
            },
            error: function (xhr, status, error) {
                showError('Ошибка загрузки: ' + error);
            }
        });
    }

    // Обновление информации о сообщении
    function updateMessageInfo(message, fields = {}) {
        if (!message) return;

        // Очищаем предыдущие данные
        $('#infoTo').empty();
        $('#infoToCC').empty();
        $('#infoBCC').empty();
        $('#infoCaption').empty();

        // Заполняем блок с информацией
        $('#infoUUID').text(message.uuid || message.UUID || 'Нет');
        $('#infoType').html(getTypeBadge(message.typeMes || ''));

        // Форматирование дат
        if (message.dateCreate) {
            const dateCreate = new Date(message.dateCreate);
            $('#infoDateCreate').text(formatDateTime(dateCreate));
        } else {
            $('#infoDateCreate').text('-');
        }

        if (message.dateEnd) {
            const dateEnd = new Date(message.dateEnd);
            $('#infoDateEnd').text(formatDateTime(dateEnd));
        } else {
            $('#infoDateEnd').html('<span class="text-muted">-</span>');
        }

        $('#infoStatus').html(getStatusBadge(message.status || ''));
        $('#infoAttempts').html(getAttemptsBadge(message.numAttempt || 0));

        // Заполняем адреса и тему из fields или из message
        const to = fields.To || message.to || '';
        const toCC = fields.ToCC || message.toCC || '';
        const bcc = fields.BCC || message.bcc || '';
        const caption = fields.Caption || message.caption || '';

        // Отображаем тему
        $('#infoCaption').text(caption || 'Без темы');

        // Отображаем адреса
        displayEmailList('#infoTo', to);
        displayEmailList('#infoToCC', toCC);
        displayEmailList('#infoBCC', bcc);

        $('#messageInfo').show();
    }

    // Отображение списка email
    function displayEmailList(selector, emails) {
        const container = $(selector);

        if (!emails || emails.trim() === '') {
            container.html('<div class="text-muted small">Нет адресов</div>');
            return;
        }

        // Разделяем email по запятой или точке с запятой
        const emailList = emails.split(/[,;]/).map(email => email.trim()).filter(email => email);

        if (emailList.length === 0) {
            container.html('<div class="text-muted small">Нет адресов</div>');
            return;
        }

        // Создаем список email
        let html = '';
        emailList.forEach(email => {
            // Проверяем, является ли это email
            const isEmail = email.includes('@');
            const emailClass = isEmail ? 'email-address' : '';

            html += `<div class="${emailClass} mb-1 small">${escapeHtml(email)}</div>`;
        });

        container.html(html);
    }

    // Функция для получения HTML бейджа типа
    function getTypeBadge(type) {
        if (!type) return '<span class="type-badge type-default">-</span>';

        switch (type.toUpperCase()) {
            case 'EMAIL':
                return '<span class="type-badge type-email">' + type + '</span>';
            case 'SMS':
                return '<span class="type-badge type-sms">' + type + '</span>';
            case 'PUSH':
                return '<span class="type-badge type-push">' + type + '</span>';
            default:
                return '<span class="type-badge type-default">' + type + '</span>';
        }
    }

    // Функция для получения HTML бейджа статуса
    function getStatusBadge(status) {
        if (!status) return '<span class="status-badge status-null">Нет</span>';

        switch (status.toUpperCase()) {
            case 'SUCCESS':
                return '<span class="status-badge status-success">' + status + '</span>';
            case 'ERROR':
                return '<span class="status-badge status-error">' + status + '</span>';
            default:
                return '<span class="status-badge status-pending">' + status + '</span>';
        }
    }

    // Функция для получения HTML бейджа попыток
    function getAttemptsBadge(attempts) {
        const badgeClass = attempts > 3 ? 'badge bg-danger' : 'badge bg-secondary';
        return '<span class="' + badgeClass + '">' + attempts + '</span>';
    }

    // Форматирование даты и времени
    function formatDateTime(date) {
        if (!date) return '';

        return date.toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    // Отображение содержимого сообщения
    function displayMessageContent(content) {
        if (!content) {
            showError('Нет содержимого');
            return;
        }

        // Сохраняем исходный контент
        window.currentMessageContent = content;

        // Сбрасываем режим просмотра
        currentViewMode = 'preview';

        // Отображаем в зависимости от содержания HTML
        if (content.includes('<') && content.includes('>')) {
            // Содержит HTML - показываем в iframe
            showHtmlPreview(content);
        } else {
            // Простой текст
            showTextContent(content);
        }
    }

    // Показать HTML в iframe
    function showHtmlPreview(htmlContent) {
        const iframeId = 'message-iframe-' + Date.now();
        const escapedContent = escapeHtml(htmlContent)
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/\r?\n/g, ' ');

        const html = `
            <div id="previewView">
                <div class="border rounded">
                    <div class="border-bottom p-2 bg-light d-flex justify-content-between">
                        <small class="text-muted">Предпросмотр HTML</small>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showSourceView()">
                            <i class="fas fa-code"></i> Исходный код
                        </button>
                    </div>
                    <iframe
                        id="${iframeId}"
                        srcdoc="${escapedContent}"
                        style="width: 100%; height: 300px; border: none;"
                        sandbox="allow-same-origin"
                        title="HTML содержимое"
                    ></iframe>
                </div>
            </div>
            <div id="sourceView" style="display: none;">
                <div class="border rounded">
                    <div class="border-bottom p-2 bg-light d-flex justify-content-between">
                        <small class="text-muted">Исходный код HTML</small>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showPreviewView()">
                            <i class="fas fa-eye"></i> Предпросмотр
                        </button>
                    </div>
                    <pre class="p-3 mb-0" style="max-height: 300px; overflow: auto;">${escapeHtml(htmlContent)}</pre>
                </div>
            </div>
        `;

        $('#htmlContainer').html(html);

        // Настройка iframe
        setTimeout(() => {
            const iframe = document.getElementById(iframeId);
            if (iframe) {
                iframe.onload = function () {
                    try {
                        const doc = iframe.contentDocument || iframe.contentWindow.document;
                        iframe.style.height = Math.max(300, doc.body.scrollHeight + 20) + 'px';
                    } catch (e) {
                        console.log('Не удалось изменить размер iframe');
                    }
                };
            }
        }, 100);
        setTimeout(() => {
            resizeContentIframe();
        }, 200);
    }

    // Показать текстовое содержимое
    function showTextContent(textContent) {
        const html = `
            <div class="border rounded">
                <div class="border-bottom p-2 bg-light">
                    <small class="text-muted">Текстовое содержимое</small>
                </div>
                <pre class="p-3 mb-0" style="max-height: 300px; overflow: auto; white-space: pre-wrap;">${escapeHtml(textContent)}</pre>
            </div>
        `;
        $('#htmlContainer').html(html);
        setTimeout(() => {
            resizeContentIframe();
        }, 100);
    }

    // Добавляем обработчик ресайза окна
    window.addEventListener('resize', function() {
        resizeContentIframe();
    });

    // Переключение между предпросмотром и исходным кодом
    function toggleView() {
        if (currentViewMode === 'preview') {
            showSourceView();
        } else {
            showPreviewView();
        }
    }

    function showPreviewView() {
        $('#sourceView').hide();
        $('#previewView').show();
        currentViewMode = 'preview';
    }

    function showSourceView() {
        $('#previewView').hide();
        $('#sourceView').show();
        currentViewMode = 'source';
    }

    // Поиск в тексте
    function searchInContent() {
        const searchText = prompt('Введите текст для поиска:');
        if (!searchText) return;

        const content = window.currentMessageContent;
        if (!content) return;

        const regex = new RegExp(escapeRegExp(searchText), 'gi');
        const highlighted = content.replace(regex, match => `<mark>${match}</mark>`);

        if (currentViewMode === 'source') {
            $('#sourceView pre').html(escapeHtml(highlighted).replace(/\n/g, '<br>'));
        } else {
            // Для HTML предпросмотра нужно обновить iframe
            showHtmlPreview(highlighted);
        }
    }

    // Подсветка email
    function highlightEmail() {
        // Получаем email из поля поиска, а не из несуществующего поля с id "email"
        const email = $('#emailInput').val();
        if (!email || email.trim() === '') {
            alert('Сначала введите email в поле поиска выше');
            return;
        }

        const content = window.currentMessageContent;
        if (!content) {
            alert('Сначала выберите сообщение из таблицы');
            return;
        }

        // Экранируем спецсимволы для использования в регулярном выражении
        const escapedEmail = escapeRegExp(email.trim());
        const regex = new RegExp(escapedEmail, 'gi');

        // Подсвечиваем найденные совпадения
        const highlighted = content.replace(regex, match => `<span style="background-color: yellow; font-weight: bold;">${match}</span>`);

        // Обновляем отображение в зависимости от текущего режима просмотра
        if (currentViewMode === 'source') {
            // В режиме исходного кода
            $('#sourceView pre').html(escapeHtml(highlighted).replace(/\n/g, '<br>'));
        } else if (currentViewMode === 'preview') {
            // В режиме предпросмотра HTML
            showHtmlPreview(highlighted);
        } else {
            // Для текстового содержимого
            const html = `
                <div class="border rounded">
                    <div class="border-bottom p-2 bg-light">
                        <small class="text-muted">Текстовое содержимое (email подсвечен)</small>
                    </div>
                    <pre class="p-3 mb-0" style="max-height: 300px; overflow: auto; white-space: pre-wrap;">${escapeHtml(highlighted)}</pre>
                </div>
            `;
            $('#htmlContainer').html(html);
        }

        // Показываем сообщение о количестве найденных совпадений
        const matches = (content.match(regex) || []).length;
        if (matches > 0) {
            showNotification(`Найдено ${matches} совпадений для email: ${email}`, 'success');
        } else {
            showNotification(`Email "${email}" не найден в содержимом сообщения`, 'warning');
        }
    }

    // Вспомогательная функция для показа уведомлений
    function showNotification(message, type = 'info') {
        // Создаем временное уведомление
        const alertClass = type === 'success' ? 'alert-success' :
            type === 'warning' ? 'alert-warning' :
                type === 'error' ? 'alert-danger' : 'alert-info';

        const notification = $(`
            <div class="alert ${alertClass} alert-dismissible fade show" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} me-2"></i>${message}
            </div>
        `);

        $('body').append(notification);

        // Автоматическое скрытие через 3 секунды
        setTimeout(() => {
            notification.alert('close');
        }, 3000);
    }

    // Копирование содержимого
    function copyContent() {
        if (!window.currentMessageContent) {
            alert('Сначала выберите сообщение');
            return;
        }

        navigator.clipboard.writeText(window.currentMessageContent)
            .then(() => showNotification('Содержимое скопировано в буфер обмена', 'success'))
            .catch(err => showNotification('Ошибка копирования: ' + err, 'error'));
    }

    // Копирование деталей сообщения
    function copyDetails() {
        if (!currentMessageData.message) {
            alert('Сначала выберите сообщение');
            return;
        }

        const message = currentMessageData.message;
        const fields = currentMessageData.fields || {};

        let details = 'Детали сообщения:\n';
        details += '===================\n';
        details += `ID: ${message.id || '-'}\n`;
        details += `UUID: ${message.uuid || message.UUID || '-'}\n`;
        details += `Тип: ${message.typeMes || '-'}\n`;
        details += `Статус: ${message.status || '-'}\n`;
        details += `Попыток: ${message.numAttempt || 0}\n`;

        if (message.dateCreate) {
            const dateCreate = new Date(message.dateCreate);
            details += `Дата создания: ${formatDateTime(dateCreate)}\n`;
        }

        if (message.dateEnd) {
            const dateEnd = new Date(message.dateEnd);
            details += `Дата окончания: ${formatDateTime(dateEnd)}\n`;
        }

        details += `\nАдресаты:\n`;
        details += `---------\n`;
        details += `Тема: ${fields.Caption || message.caption || '-'}\n`;
        details += `To: ${fields.To || message.to || '-'}\n`;
        details += `ToCC: ${fields.ToCC || message.toCC || '-'}\n`;
        details += `BCC: ${fields.BCC || message.bcc || '-'}\n`;
        details += `\nТопик Kafka: ${message.kafkaTopic || '-'}\n`;
        details += `Сервер: ${message.server || '-'}\n`;

        navigator.clipboard.writeText(details)
            .then(() => showNotification('Детали сообщения скопированы в буфер обмена', 'success'))
            .catch(err => showNotification('Ошибка копирования: ' + err, 'error'));
    }

    // Обновление UI
    function updateUI() {
        // Обновляем счетчик
        $('#selectedCount').text(selectedMessages.length);

        // Обновляем состояние кнопки
        $('#resendBtn').prop('disabled', selectedMessages.length === 0);

        // Обновляем выделение строк
        $('.clickable-row').each(function () {
            const row = $(this);
            const messageId = row.data('id');
            const checkbox = row.find('.message-checkbox');

            if (selectedMessages.includes(messageId)) {
                row.addClass('selected');
                checkbox.prop('checked', true);
            } else {
                if (currentSelectedId !== messageId) {
                    row.removeClass('selected');
                }
                checkbox.prop('checked', false);
            }
        });
    }

    // Отправка выбранных сообщений повторно
    function resendSelectedMessages() {
        if (selectedMessages.length === 0) return;

        if (!confirm(`Отправить повторно ${selectedMessages.length} сообщений?`)) {
            return;
        }

        // Показываем анимацию загрузки
        $('#loadingOverlay').show();
        $('#loadingSpinner').show();

        // Отправляем запрос на сервер
        $.ajax({
            url: '/api/resend',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({messageIds: selectedMessages}),
            success: function (response) {
                if (response.success) {
                    showNotification(`Успешно обновлено: ${response.updatedCount} сообщений`, 'success');

                    // Обновляем данные в таблице
                    if (response.messages) {
                        response.messages.forEach(msg => {
                            updateTableRow(msg);
                        });
                    }
                } else {
                    showNotification('Ошибка: ' + (response.error || 'Неизвестная ошибка'), 'error');
                }
            },
            error: function () {
                showNotification('Ошибка при отправке запроса', 'error');
            },
            complete: function () {
                // Скрываем анимацию загрузки
                $('#loadingOverlay').hide();
                $('#loadingSpinner').hide();

                // Сбрасываем выбор
                selectedMessages = [];
                updateUI();
                $('#selectAll, #selectAllTable').prop('checked', false);
            }
        });
    }

    // Обновление строки таблицы
    function updateTableRow(message) {
        const row = $(`tr[data-id="${message.id}"]`);
        if (row.length) {
            // Обновляем UUID
            const uuidCell = row.find('td:nth-child(3)');
            uuidCell.find('small').text(message.uuid ? abbreviate(message.uuid, 15) : 'Нет');
            uuidCell.attr('title', message.uuid || '');

            // Обновляем тип сообщения
            const typeCell = row.find('td:nth-child(4)');
            typeCell.empty();
            typeCell.append(getTypeBadge(message.typeMes || ''));

            // Обновляем статус
            const statusCell = row.find('td:nth-child(6)');
            statusCell.empty();
            statusCell.append(getStatusBadge(message.status || ''));

            // Обновляем дату окончания
            const dateEndCell = row.find('td:nth-child(8)');
            if (message.dateEnd) {
                const dateEnd = new Date(message.dateEnd);
                dateEndCell.find('small').text(formatDateTime(dateEnd));
            } else {
                dateEndCell.html('<small class="text-muted">-</small>');
            }

            // Обновляем количество попыток
            const attemptsCell = row.find('td:nth-child(9)');
            attemptsCell.empty();
            attemptsCell.append(getAttemptsBadge(message.numAttempt || 0));
        }
    }

    // Вспомогательные функции
    function showError(message) {
        $('#htmlContainer').html(`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
            </div>
        `);
    }

    // Выбор даты из списка
    function selectDate(element) {
        const dateValue = $(element).data('date');
        $('#dateInput').val(dateValue);
        $('#dateSuggestions').hide();

        // Можно автоматически отправить форму
        // $('#searchForm').submit();
    }

    // Очистка поля даты
    function clearDate() {
        $('#dateInput').val('');
        // Также очищаем поле в форме
        $('input[name="dateCreate"]').val('');
        // Можно отправить форму для поиска без даты
        // $('#searchForm').submit();
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function abbreviate(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength - 3) + '...';
    }

    // Функция для переключения видимости блока с информацией о сообщении
    function toggleMessageInfo() {
        const messageInfo = document.getElementById('messageInfo');
        const toggleIcon = document.getElementById('detailsToggleIcon');
        const htmlContainer = document.querySelector('.html-container');

        if (messageInfo.style.display === 'none' || messageInfo.classList.contains('hidden')) {
            // Показываем блок
            messageInfo.style.display = 'block';
            messageInfo.classList.remove('hidden');
            toggleIcon.className = 'fas fa-chevron-up ms-1';

            // Убираем класс расширения с контейнера содержимого
            htmlContainer.classList.remove('expanded');

            // Сохраняем состояние в localStorage
            localStorage.setItem('messageInfoVisible', 'true');

            // Принудительно обновляем размер iframe после анимации
            setTimeout(() => {
                resizeContentIframe();
            }, 300);
        } else {
            // Скрываем блок
            messageInfo.classList.add('hidden');
            toggleIcon.className = 'fas fa-chevron-down ms-1';

            // Добавляем класс расширения к контейнеру содержимого
            htmlContainer.classList.add('expanded');

            // Сохраняем состояние в localStorage
            localStorage.setItem('messageInfoVisible', 'false');

            // Даем время для анимации перед обновлением высоты
            setTimeout(() => {
                resizeContentIframe();
            }, 300);
        }
    }

    // Функция для обновления размеров iframe с содержимым
    function resizeContentIframe() {
        const iframe = document.querySelector('#htmlContainer iframe');
        if (iframe) {
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;

                // Получаем видимую высоту контейнера
                const container = document.querySelector('.html-container');
                const containerHeight = container.clientHeight;

                // Устанавливаем высоту iframe (минус отступы)
                const newHeight = Math.max(containerHeight - 120, 300);
                iframe.style.height = newHeight + 'px';

                // Обновляем высоту iframe для отображения всего содержимого
                setTimeout(() => {
                    const contentHeight = Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight);
                    iframe.style.height = Math.max(contentHeight + 20, newHeight) + 'px';
                }, 100);
            } catch (e) {
                console.log('Не удалось обновить размер iframe:', e);
            }
        }
    }

    // Функция для восстановления состояния блока из localStorage
    function restoreMessageInfoState() {
        const savedState = localStorage.getItem('messageInfoVisible');
        const messageInfo = document.getElementById('messageInfo');
        const toggleIcon = document.getElementById('detailsToggleIcon');
        const htmlContainer = document.querySelector('.html-container');

        if (savedState === 'true') {
            // Показываем блок
            messageInfo.style.display = 'block';
            messageInfo.classList.remove('hidden');
            if (toggleIcon) {
                toggleIcon.className = 'fas fa-chevron-up ms-1';
            }
            htmlContainer.classList.remove('expanded');
        } else {
            // Скрываем блок
            messageInfo.style.display = 'none';
            messageInfo.classList.add('hidden');
            if (toggleIcon) {
                toggleIcon.className = 'fas fa-chevron-down ms-1';
            }
            htmlContainer.classList.add('expanded');

            // Обновляем высоту iframe после восстановления состояния
            setTimeout(() => {
                resizeContentIframe();
            }, 100);
        }
    }

    // ========== ФУНКЦИИ ДЛЯ РЕДАКТИРОВАНИЯ ==========

    // Переключение режима редактирования
    function toggleEditMode() {
        if (!currentSelectedId) {
            alert('Сначала выберите сообщение');
            return;
        }

        if (!isEditMode) {
            // Переходим в режим редактирования
            enterEditMode();
        } else {
            // Выходим из режима редактирования
            exitEditMode();
        }
    }

    // Вход в режим редактирования
    function enterEditMode() {
        isEditMode = true;

        // Сохраняем оригинальные значения
        originalFields = {
            To: $('#infoTo').text().trim(),
            ToCC: $('#infoToCC').text().trim(),
            BCC: $('#infoBCC').text().trim()
        };

        // Заполняем поля формы
        $('#editTo').val(formatEmailListForEdit(originalFields.To));
        $('#editToCC').val(formatEmailListForEdit(originalFields.ToCC));
        $('#editBCC').val(formatEmailListForEdit(originalFields.BCC));

        // Переключаем отображение
        $('#viewMode').hide();
        $('#editMode').show();

        // Обновляем иконку
        $('#editIcon').removeClass('fa-edit').addClass('fa-times');
    }

    // Выход из режима редактирования
    function exitEditMode() {
        isEditMode = false;

        // Переключаем отображение
        $('#viewMode').show();
        $('#editMode').hide();

        // Обновляем иконку
        $('#editIcon').removeClass('fa-times').addClass('fa-edit');
    }

    // Отмена редактирования
    function cancelEdit() {
        exitEditMode();
    }

    // Сохранение изменений
    function saveChanges(event) {
        event.preventDefault();

        if (!currentSelectedId) return;

        // Показываем загрузку
        $('#loadingOverlay').show();
        $('#loadingSpinner').show();

        // Подготавливаем данные
        const updateData = {
            to: $('#editTo').val().trim(),
            toCC: $('#editToCC').val().trim(),
            bcc: $('#editBCC').val().trim()
        };

        // Отправляем запрос на сервер
        $.ajax({
            url: '/api/message/' + currentSelectedId + '/update',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(updateData),
            success: function(response) {
                if (response.success) {
                    // Обновляем отображение
                    displayEmailList('#infoTo', updateData.to);
                    displayEmailList('#infoToCC', updateData.toCC);
                    displayEmailList('#infoBCC', updateData.bcc);

                    // Выходим из режима редактирования
                    exitEditMode();

                    // Показываем уведомление
                    showNotification(response.message || 'Данные успешно обновлены', 'success');

                    // Обновляем данные в памяти
                    if (currentMessageData.fields) {
                        currentMessageData.fields.To = updateData.to;
                        currentMessageData.fields.ToCC = updateData.toCC;
                        currentMessageData.fields.BCC = updateData.bcc;
                    }
                } else {
                    showNotification('Ошибка: ' + (response.error || 'Неизвестная ошибка'), 'error');
                }
            },
            error: function(xhr, status, error) {
                showNotification('Ошибка сети: ' + error, 'error');
            },
            complete: function() {
                $('#loadingOverlay').hide();
                $('#loadingSpinner').hide();
            }
        });
    }

    // Редактирование конкретного поля
    function editField(fieldName) {
        if (!currentSelectedId) {
            alert('Сначала выберите сообщение');
            return;
        }

        // Переходим в режим редактирования
        if (!isEditMode) {
            enterEditMode();
        }

        // Фокусируемся на нужном поле
        switch(fieldName) {
            case 'To':
                $('#editTo').focus();
                break;
            case 'ToCC':
                $('#editToCC').focus();
                break;
            case 'BCC':
                $('#editBCC').focus();
                break;
        }
    }

    // Форматирование списка email для редактирования
    function formatEmailListForEdit(text) {
        if (!text || text === 'Нет адресов') return '';

        // Разделяем по переносам строк и удаляем HTML теги
        return text.split('\n')
            .map(line => line.replace(/<[^>]*>/g, '').trim())
            .filter(line => line && line !== 'Нет адресов')
            .join(', ');
    }
</script>
</body>
</html>